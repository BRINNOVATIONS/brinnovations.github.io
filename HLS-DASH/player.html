<!DOCTYPE html>
<html>
<head>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/shaka-player@4.8.1/dist/shaka-player.ui.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shaka-player@4.8.1/dist/controls.min.css">

<style>
html, body {
    width: 100%;
    height: 100%;
    margin: 0;
    padding: 0;
    background: #fff;
    font-family: Poppins, sans-serif;
    overflow: hidden;
}

div[data-shaka-player-container] {
    width: 100%;
    height: 28vh;
}

video {
    width: 100%;
    height: 100%;
    object-fit: fill;
    background: #fff;
    user-select: none;
}
</style>

</head>

<body>

<div data-shaka-player-container data-shaka-player-cast-receiver-id="1BA79154">
    <video
        id="video"
        autoplay
        muted
        playsinline
        data-shaka-player>
    </video>
</div>

<script>
const params = new URLSearchParams(window.location.search);

const manifestUri = params.get('url') || '';
const keyId       = params.get('keyId') || '';
const key         = params.get('key') || '';
const cookieValue = params.get('cookie') || '';
const originValue = params.get('origin') || '';
const refererValue = params.get('referer') || '';

async function init() {

    if (!manifestUri) {
        console.error('Manifest URL missing');
        return;
    }

    const video = document.getElementById('video');
    const ui = video.ui;
    const controls = ui.getControls();
    const player = controls.getPlayer();

    /* UI CONFIG */
    ui.configure({
        controlPanelElements: [
            'play_pause',
            'time_and_duration',
            'mute',
            'volume',
            'spacer',
            'picture_in_picture',
            'playback_rate',
            'quality',
            'fullscreen'
        ],
        playbackRates: [0.5, 0.75, 1, 1.25, 1.5, 1.75, 2]
    });

    /* PLAYER CONFIG */
    player.configure({
        streaming: {
            rebufferingGoal: 2,
            bufferingGoal: 15,
            lowLatencyMode: false
        },
        drm: {
            clearKeys: keyId && key ? {
                [keyId]: key
            } : {}
        }
    });

    /* NETWORK REQUEST HEADERS */
    const netEngine = player.getNetworkingEngine();

    netEngine.registerRequestFilter((type, request) => {
        if (cookieValue) {
            request.headers['Cookie'] = cookieValue;
        }
        if (originValue) {
            request.headers['Origin'] = originValue;
        }
        if (refererValue) {
            request.headers['Referer'] = refererValue;
        }
    });

    /* ERROR HANDLING */
    player.addEventListener('error', onPlayerErrorEvent);
    controls.addEventListener('error', onUIErrorEvent);

    try {
        await player.load(manifestUri);
        console.log('Video loaded successfully');
    } catch (error) {
        onPlayerError(error);
    }
}

function onPlayerErrorEvent(errorEvent) {
    onPlayerError(errorEvent.detail);
}

function onUIErrorEvent(errorEvent) {
    onPlayerError(errorEvent.detail);
}

function onPlayerError(error) {
    console.error('Shaka Error', error.code, error);
}

function initFailed() {
    console.error('Shaka UI failed to load');
}

document.addEventListener('shaka-ui-loaded', init);
document.addEventListener('shaka-ui-load-failed', initFailed);
</script>

</body>
</html>
